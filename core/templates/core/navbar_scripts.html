<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 🔍 Search functionality
    const searchIcon = document.getElementById('searchIcon');
    const searchContainer = document.getElementById('searchContainer');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');

    if (searchIcon && searchContainer && searchInput && searchResults) {
      searchIcon.addEventListener('click', () => {
        searchContainer.classList.toggle('d-none');
        if (!searchContainer.classList.contains('d-none')) searchInput.focus();
      });

      searchInput.addEventListener('input', () => {
        const query = searchInput.value.trim();
        searchResults.innerHTML = '';
        if (!query) return;

        fetch(`/live-search/?q=${query}`)
          .then(res => res.json())
          .then(data => {
            searchResults.innerHTML = '';
            if (data.results && data.results.length > 0) {
              data.results.forEach(user => {
                const div = document.createElement('div');
                div.classList.add('p-2', 'border-bottom', 'search-result-item');
                div.textContent = user.username;
                div.style.cursor = 'pointer';
                div.addEventListener('click', () => {
                  window.location.href = `/profile/${user.username}/`;
                });
                searchResults.appendChild(div);
              });
            } else {
              const div = document.createElement('div');
              div.classList.add('p-2', 'text-muted');
              div.textContent = 'No users found';
              searchResults.appendChild(div);
            }
          })
          .catch(err => console.error('Search error:', err));
      });
    }
  });
</script>
{% if user.is_authenticated %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const userId = "{{ user.id }}";
    const notificationsIcon = document.getElementById('notificationsIcon');
    const notificationList = document.getElementById('notificationList');
    const notificationBadge = document.getElementById('notificationBadge');

    const wsScheme = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const ws = new WebSocket(`${wsScheme}://${window.location.host}/ws/notifications/${userId}/`);

    ws.onopen = () => console.log("WebSocket connected for user:", userId);

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      const li = document.createElement('li');
      li.className = 'list-group-item p-2';
      li.textContent = data.text;
      notificationList.prepend(li);

      notificationBadge.style.display = 'inline';
      notificationBadge.textContent = parseInt(notificationBadge.textContent || '0') + 1;
    };

    notificationsIcon.addEventListener('click', () => {
      notificationList.style.display =
        notificationList.style.display === 'none' ? 'block' : 'none';
      notificationBadge.style.display = 'none';
      notificationBadge.textContent = '0';
    });
  });
</script>
{% endif %}